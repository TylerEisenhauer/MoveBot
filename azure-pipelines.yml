# Node.js
# Build a general Node.js project with npm.
# Add steps that analyze code, save build artifacts, deploy, and more:
# https://docs.microsoft.com/azure/devops/pipelines/languages/javascript

trigger:
- master

pool:
  vmImage: 'ubuntu-latest'

stages:
  - stage: Build
    jobs:
      - job: Build
        steps:
          - task: NodeTool@0
            inputs:
              versionSpec: '13.x'
            displayName: 'Install Node.js'

          - task: YarnInstaller@3
            inputs:
              versionSpec: '1.x'

          - script: |
              yarn install
              yarn build
            displayName: 'Yarn install and build'

          - publish: $(System.DefaultWorkingDirectory)/build
            artifact: NukeBot
            displayName: 'Publish Artifacts'

  - stage: DeployProd
    # condition: and(succeeded(), eq(variables['Build.SourceBranchName'], 'master'))
    displayName: 'Deploy Production'
    dependsOn: Build
    jobs:
      - job: DeployProduction
        steps:
          - download: current
            artifact: NukeBot
            displayName: 'Download Artifacts'

          - script: |
              cd $(Pipeline.Workspace)
              pwd
              ls
              
          - task: CopyFilesOverSSH@0
            inputs:
              sshEndpoint: 'Nighthawk'
              sourceFolder: '$(Pipeline.Workspace)/NukeBot'
              contents: 'index.js'
              targetFolder: $(TargetFolder)

          - task: SSH@0
            inputs:
              sshEndpoint: 'Nighthawk'
              runOptions: 'commands'
              commands: |
                sudo chown discord $(TargetFolder)/index.js
                sudo systemctl restart discord-bot